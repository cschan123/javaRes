# 高性能mysql

### 第三章、服务器性能剖析

三个问题：

1、如何确认服务器是否达到性能最佳的状态？

2、找到某条语句为什么执行不够快？

3、诊断被用户描述成停顿，卡死的某些间歇性疑难故障？

完成一项任务所需时间分两部分，执行时间和等待时间

优化任务执行时间，最好办法就是通过测量定位不同的子任务花费的时间，然后优化去掉一些子任务，降低子任务的执行频率或者提升子任务的效率。

优化任务等待时间问题，有可能是其他系统间接影响导致，挺复杂的，任务之间需要争取磁盘或者CPU资源相互影响

需要不同的工具和技术

#### 3.1 性能优化

##### 3.1.1通过性能剖析进行优化

性能剖析是测量和分析时间花费在哪里的主要方法；主要右两个步骤：

1、测量任务所花费时间；

2、对结果进行统计和排序，将重要的任务排到前面；

##### 3.1.2 理解性能剖析

1、值得优化的查询；对响应时间不超过5%的查询优化，其收益不会超过5%

2、异常情况；执行次数少，但是每次执行很慢

3、未知的未知；未显示丢失时间，但是很慢

4、被掩藏的细节；平均时间是可怕的，更应该响应时间的更多信息；

#### 3.2 对应用程序进行性能剖析

性能瓶颈的因素：

外部资源，比如调用外部的web服务或者搜索引擎

应用需要处理大量的数据，如分析一个超大的xml文件

在循环中执行昂贵的操作；如滥用正则表达式

低效率的算法；如暴力搜索查找；

#### 3.3 剖析MySQL查询

##### 3.3.1剖析服务器负载

慢查询日志

**分析查询日志**

利用慢查询日志捕获服务器上的所有查询，进行分析。如一些典型的时间窗口业务高峰期的一个小时内记录查询，

工具 为Pt-qurey-digest

##### 3.3.2 剖析单条查询

SHOW PROFILES;
SHOW  GLOBAL STATUS;

Explain + SQL;

##### 3.3.3 使用性能剖析

#### 3.4诊断间歇性问题

![image-20210717113601983](C:\Users\CS_Chan\AppData\Roaming\Typora\typora-user-images\image-20210717113601983.png)

##### 3.4.1 单条查询还是服务器问题？

如果问题不停的周期性初夏，那可可以在某次活动中观察到，或者整夜运行脚本收集数据，第二天分析结果，大多数情况可以通过三种技术来解决：

**1、使用SHOW  GLOBAL STATUS;**

这个方法实际上就是比较高的频率比如一秒执行一次SHOW  GLOBAL STATUS;命令捕获数据，问题出现时，可以通过某些计数器（Thread_running,Theads_connected,Questions和Queries）的尖刺和凹陷来发现问题；这个方法很简单，对服务器性能查询小；例子每秒查询书一般会下跌，而其他两个则至少有一个会出现尖刺问题。这个例子应该使用连接池，所以,Theads_connected,没有变化，但是正在执行的查询的线程数明显上升，同时每秒的查询数相比正常数据有严重的下跌；

原因很有可能有两个：其一是服务器内部碰到瓶颈，导致新查询在开始执行前因为获取老查询正在等待的锁而造成堆积，这一类的锁一般也会对应用服务器造成后端压力，使得服务器也出现排队问题；其二是服务区突然遇到大量查询请求的冲击；每一秒输出一行数据。可以运行几个小时或者几天，然后将结果绘制成图形，这样方便查询是否有趋势的突变

2、使用SHOW PROCESSLIST;

这个方法通过不停的捕获SHOW PROCESSLIST;的输出；来观察是否有大量线程处于不正常的状态或者其他不正常的特征。例如查询很少会长时间处于statistics状态，这个状态一般是指服务器在查询优化阶段如何确定表关联的顺序，通常都是非常快的，另外很少会见到大量的线程报告当前连接用户是“未经过验证的同步”，这只是在连接握手的中间过程中的状态，当客户端等待输入用于登录的用户信息才会出现。

使用SHOW PROCESSLIST命令时。在尾部加上\G可以垂直输出结果，这很有用，因为这样获奖每一行的记录单独输出为一行，